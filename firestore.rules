rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isValidFusedPokemon() {
      let data = request.resource.data;
      return data.keys().hasAll(['name', 'types', 'stats', 'moves', 'basePokemon', 'createdAt']) &&
             data.name is string &&
             data.name.size() > 0 &&
             data.name.size() <= 100 &&
             data.types is list &&
             data.types.size() > 0 &&
             data.types.size() <= 2 &&
             data.stats is list &&
             data.stats.size() == 6 &&
             data.moves is list &&
             data.moves.size() > 0 &&
             data.moves.size() <= 4 &&
             data.basePokemon is list &&
             data.basePokemon.size() == 3 &&
             data.createdAt is timestamp;
    }

    function validateFusedPokemonData() {
      let data = request.resource.data;
      return isValidFusedPokemon() &&
             data.stats.size() == 6 &&
             data.moves.size() > 0 &&
             data.moves.size() <= 4 &&
             data.basePokemon.size() == 3;
    }

    match /favorites/{favoriteId} {
      allow read: if true;
      allow create: if validateFusedPokemonData();
      allow update: if validateFusedPokemonData() &&
                       resource.data.createdAt == request.resource.data.createdAt;
      allow delete: if true;
    }
  }
}

